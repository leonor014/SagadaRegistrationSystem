<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tourist Site Registration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="./style.css">
</head>

<body id="body">
  <!-- Navigation Section -->
  <nav class="navbar">
    <div class="nav-container">
      <!-- Hamburger Button -->
      <button class="hamburger" id="hamburger">☰</button>

      <!-- Nav Links -->
      <div class="nav-links" id="nav-links">
        <a href="/SagadaRegistrationSystem/index.html">Home</a>
        <a href="/SagadaRegistrationSystem/about/index.html">About</a>
        <a href="/SagadaRegistrationSystem/contact/index.html">Contact</a>
        <a id="registerLink" href="/SagadaRegistrationSystem/user/register/index.html">Register</a>
        <!-- <a id="touristCheckInLink"
                    href="/SagadaRegistrationSystem/user/registration-per-site/index.html">Tourist Site Check-In</a> -->
        <a id="authLink" href="/SagadaRegistrationSystem/user/user-auth.html">Login</a>
        <!-- <a id="logoutLink" href="#">Logout</a> -->
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>Tourist Site Registration</h2>
    <label for="registrationNumber">Enter Registration Number:</label>
    <input type="text" id="registrationNumber" value="REG-">
    <button id="fetchDetailsBtn" class="button">Fetch Details</button>

    <p id="error" class="error"></p>

    <div id="touristDetails" class="tourist-details" style="display:none;">
      <h3>Tourist Details</h3>
      <p><strong>Registered Tourists:</strong></p>

      <table id="touristTable" border="1">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Tourist Name</th>
            <th>Age</th>
            <th>Sex</th>
            <th>Nationality</th>
          </tr>
        </thead>
        <tbody id="touristList"></tbody>
      </table>
      <div id="pagination" style="text-align:center; margin-top:10px;"></div>

      <label for="siteSelect">Select Tourist Site:</label>
      <select id="siteSelect">
        <option value="Lumiang Cave">Lumiang Cave</option>
        <option value="Sumaguing Cave">Sumaguing Cave</option>
        <option value="Balangagan Cave">Balangagan Cave</option>
        <option value="Bomod-ok Falls">Bomod-ok Falls</option>
        <option value="Pongas Falls">Pongas Falls</option>
        <option value="Bokong Falls">Bokong Falls</option>
        <option value="Ubwa Blue Lagoon">Ubwa Blue Lagoon</option>
        <option value="Ticangan to Ubwa River Tracing, Bouldering and Swimming">Ticangan to Ubwa River Tracing,
          Bouldering and Swimming</option>
        <option value="Ampacao">Ampacao</option>
        <option value="Nabas-ang to Ampacao">Nabas-ang to Ampacao</option>
        <option value="Langsayan">Langsayan</option>
        <option value="Marlboro">Marlboro</option>
        <option value="Marlboro to Blue Soil">Marlboro to Blue Soil</option>
        <option value="Blue Soil">Blue Soil</option>
        <option value="Paytokan Walk">Paytokan Walk</option>
        <option value="Hanging Coffins">Hanging Coffins</option>
        <option value="Sumaguing Cave Entrance">Sumaguing Cave Entrance</option>
        <option value="Lumiang Cave Entrance">Lumiang Cave Entrance</option>
        <option value="Dokiw Hanging Coffins">Dokiw Hanging Coffins</option>
        <option value="Kapay-aw Rice Terraces">Kapay-aw Rice Terraces</option>
      </select>
      <button id="submitAttendanceBtn" class="button">Submit Attendance</button>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Discover Sagada. All rights reserved.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCt1EginvMZvYdlrseVPBiyvfto4bvED5Y",
      authDomain: "sagadatouristregister.firebaseapp.com",
      projectId: "sagadatouristregister",
      storageBucket: "sagadatouristregister.firebasestorage.app",
      messagingSenderId: "875774905793",
      appId: "1:875774905793:web:d4fe2ea42fedba8d473340",
      measurementId: "G-2VF5GCQGZ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allTourists = [];
    let selectedTourists = new Set();
    let currentPage = 1;
    const rowsPerPage = 10;
    let totalPages = 0;

    function calculateAge(dob) {
      let birthDate = new Date(dob);
      let today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      let monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    function getNationality(country) {
      const nationalityMap = {
        "Afghanistan": "Afghan",
        "Albania": "Albanian",
        "Algeria": "Algerian",
        "Andorra": "Andorran",
        "Angola": "Angolan",
        "Antigua and Barbuda": "Antiguan, Barbudan",
        "Argentina": "Argentine, Argentinian",
        "Armenia": "Armenian",
        "Australia": "Australian",
        "Austria": "Austrian",
        "Azerbaijan": "Azerbaijani",
        "Bahamas": "Bahamian",
        "Bahrain": "Bahraini",
        "Bangladesh": "Bangladeshi",
        "Barbados": "Barbadian",
        "Belarus": "Belarusian",
        "Belgium": "Belgian",
        "Belize": "Belizean",
        "Benin": "Beninese",
        "Bolivia": "Bolivian",
        "Bosnia and Herzegovina": "Bosnian, Herzegovinian",
        "Botswana": "Motswana",
        "Brazil": "Brazilian",
        "Brunei": "Bruneian",
        "Bulgaria": "Bulgarian",
        "Burkina Faso": "Burkinabé",
        "Burma": "Burmese",
        "Burundi": "Burundian",
        "Cabo Verde": "Cabo Verdean",
        "Cambodia": "Cambodian",
        "Cameroon": "Cameroonian",
        "Canada": "Canadian",
        "Central African Republic": "Central African",
        "Chad": "Chadian",
        "Chile": "Chilean",
        "China": "Chinese",
        "Colombia": "Colombian",
        "Comoros": "Comorian",
        "Congo, Democratic Republic of the": "Congolese",
        "Congo, Republic of the": "Congolese",
        "Costa Rica": "Costa Rican",
        "Côte d'Ivoire": "Ivorian",
        "Croatia": "Croatian",
        "Cuba": "Cuban",
        "Cyprus": "Cypriot",
        "Czech Republic": "Czech",
        "Denmark": "Danish",
        "Djibouti": "Djiboutian",
        "Dominica": "Dominican",
        "Dominican Republic": "Dominian",
        "Ecuador": "Ecuadorian",
        "Egypt": "Egyptian",
        "El Salvador": "Salvadoran",
        "Equatorial Guinea": "Equatorial Guinean",
        "Eritrea": "Eritrean",
        "Estonia": "Estonian",
        "Eswatini": "Swazi",
        "Ethiopia": "Ethiopian",
        "Fiji": "Fijian",
        "Finland": "Finnish",
        "France": "French",
        "Gabon": "Gabonese",
        "Gambia": "Gambian",
        "Georgia": "Georgian",
        "Germany": "German",
        "Ghana": "Ghanaian",
        "Greece": "Greek",
        "Grenada": "Grenadian",
        "Guatemala": "Guatemalan",
        "Guinea": "Guinean",
        "Guinea-Bissau": "Bissau-Guinean",
        "Guyana": "Guyanese",
        "Haiti": "Haitian",
        "Honduras": "Honduran",
        "Hungary": "Hungarian",
        "Iceland": "Icelander",
        "India": "Indian",
        "Indonesia": "Indonesian",
        "Iran": "Iranian",
        "Iraq": "Iraqi",
        "Ireland": "Irish",
        "Israel": "Israeli",
        "Italy": "Italian",
        "Jamaica": "Jamaican",
        "Japan": "Japanese",
        "Jordan": "Jordanian",
        "Kazakhstan": "Kazakhstani",
        "Kenya": "Kenyan",
        "Kiribati": "I-Kiribati",
        "Korea, North": "North Korean",
        "Korea, South": "South Korean",
        "Kosovo": "Kosovar",
        "Kuwait": "Kuwaiti",
        "Kyrgyzstan": "Kyrgyz",
        "Laos": "Lao",
        "Latvia": "Latvian",
        "Lebanon": "Lebanese",
        "Lesotho": "Basotho",
        "Liberia": "Liberian",
        "Libya": "Libyan",
        "Liechtenstein": "Liechtensteiner",
        "Lithuania": "Lithuanian",
        "Luxembourg": "Luxembourger",
        "Madagascar": "Malagasy",
        "Malawi": "Malawian",
        "Malaysia": "Malaysian",
        "Maldives": "Maldivian",
        "Mali": "Malian",
        "Malta": "Maltese",
        "Marshall Islands": "Marshallese",
        "Mauritania": "Mauritanian",
        "Mauritius": "Mauritian",
        "Mexico": "Mexican",
        "Micronesia": "Micronesian",
        "Moldova": "Moldovan",
        "Monaco": "Monegasque",
        "Mongolia": "Mongolian",
        "Montenegro": "Montenegrin",
        "Morocco": "Moroccan",
        "Mozambique": "Mozambican",
        "Myanmar": "Burmese",
        "Namibia": "Namibian",
        "Nauru": "Nauruan",
        "Nepal": "Nepali",
        "Netherlands": "Dutch",
        "New Zealand": "New Zealander",
        "Nicaragua": "Nicaraguan",
        "Niger": "Nigerien",
        "Nigeria": "Nigerian",
        "North Macedonia": "Macedonian",
        "Norway": "Norwegian",
        "Oman": "Omani",
        "Pakistan": "Pakistani",
        "Palau": "Palauan",
        "Panama": "Panamanian",
        "Papua New Guinea": "Papua New Guinean",
        "Paraguay": "Paraguayan",
        "Peru": "Peruvian",
        "Philippines": "Filipino",
        "Poland": "Polish",
        "Portugal": "Portuguese",
        "Qatar": "Qatari",
        "Romania": "Romanian",
        "Russia": "Russian",
        "Rwanda": "Rwandan",
        "Saint Kitts and Nevis": "Kittitian",
        "Saint Lucia": "Saint Lucian",
        "Saint Vincent and the Grenadines": "Vincentian",
        "Samoa": "Samoan",
        "San Marino": "Sammarinese",
        "Saudi Arabia": "Saudi",
        "Senegal": "Senegalese",
        "Serbia": "Serbian",
        "Seychelles": "Seychellois",
        "Sierra Leone": "Sierra Leonean",
        "Singapore": "Singaporean",
        "Slovakia": "Slovak",
        "Slovenia": "Slovenian",
        "South Africa": "South African",
        "Spain": "Spanish",
        "Sri Lanka": "Sri Lankan",
        "Sudan": "Sudanese",
        "Suriname": "Surinamese",
        "Sweden": "Swedish",
        "Switzerland": "Swiss",
        "Syria": "Syrian",
        "Tajikistan": "Tajik",
        "Tanzania": "Tanzanian",
        "Thailand": "Thai",
        "Togo": "Togolese",
        "Tonga": "Tongan",
        "Tunisia": "Tunisian",
        "Turkey": "Turkish",
        "Turkmenistan": "Turkmen",
        "Uganda": "Ugandan",
        "Ukraine": "Ukrainian",
        "United Arab Emirates": "Emirati",
        "United Kingdom": "British",
        "United States": "American",
        "Uruguay": "Uruguayan",
        "Uzbekistan": "Uzbek",
        "Vanuatu": "Ni-Vanuatu",
        "Venezuela": "Venezuelan",
        "Vietnam": "Vietnamese",
        "Yemen": "Yemeni",
        "Zambia": "Zambian",
        "Zimbabwe": "Zimbabwean"
      };
      return nationalityMap[country] || "Unknown";
    }

    // --- Utility Functions ---
    function enforcePrefix(input) {
      if (!input.value.startsWith("REG-")) {
        input.value = "REG-";
      }
    }

    // --- Table Rendering ---
    function renderTablePage(page) {
      const tbody = document.getElementById("touristList");
      tbody.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedData = allTourists.slice(start, end);

      paginatedData.forEach(tourist => {
        let isChecked = selectedTourists.has(tourist.name);
        let row = document.createElement("tr");
        row.innerHTML = `
                <td><input type="checkbox" class="touristCheckbox" data-name="${tourist.name}" ${isChecked ? "checked" : ""}></td>
                <td>${tourist.name}</td>
                <td>${tourist.age}</td>
                <td>${tourist.sex}</td>
                <td>${tourist.nationality}</td>
            `;
        tbody.appendChild(row);

        // Handle checkbox
        row.querySelector(".touristCheckbox").addEventListener("change", function () {
          if (this.checked) {
            selectedTourists.add(tourist.name);
          } else {
            selectedTourists.delete(tourist.name);
          }
          syncSelectAllCheckbox();
        });
      });

      totalPages = Math.ceil(allTourists.length / rowsPerPage);
      renderPagination();
      syncSelectAllCheckbox();
    }

    function renderPagination() {
      const paginationContainer = document.getElementById("pagination");
      paginationContainer.innerHTML = "";

      // prev button
      let prevBtn = document.createElement("button");
      prevBtn.innerText = "Prev";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTablePage(currentPage);
        }
      };
      paginationContainer.appendChild(prevBtn);

      // page numbers
      for (let i = 1; i <= totalPages; i++) {
        let btn = document.createElement("button");
        btn.textContent = i;
        btn.classList.add("page-btn");
        if (i === currentPage) {
          btn.disabled = true;
        }
        btn.addEventListener("click", () => {
          currentPage = i;
          renderTablePage(currentPage);
        });
        paginationContainer.appendChild(btn);
      }

      // next button
      let nextBtn = document.createElement("button");
      nextBtn.innerText = "Next";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTablePage(currentPage);
        }
      };
      paginationContainer.appendChild(nextBtn);
    }

    // Sync Select All Checkbox
    function syncSelectAllCheckbox() {
      const selectAllBox = document.getElementById("selectAll");
      selectAllBox.checked = selectedTourists.size === allTourists.length && allTourists.length > 0;
    }

    // Handle Select All functionality
    function handleSelectAll() {
      const selectAllBox = document.getElementById("selectAll");
      if (selectAllBox.checked) {
        // Add all tourists to selected set
        allTourists.forEach(tourist => selectedTourists.add(tourist.name));
      } else {
        // Clear all selections
        selectedTourists.clear();
      }
      renderTablePage(currentPage); // Refresh the current page to show updated checkboxes
    }

    async function fetchDetails() {
      document.getElementById("error").textContent = "";
      document.getElementById("touristList").innerHTML = "";
      allTourists = [];
      selectedTourists.clear(); // Clear previous selections
      let regNumber = document.getElementById("registrationNumber").value.trim();

      if (!regNumber) {
        document.getElementById("error").textContent = "Please enter a registration number.";
        return;
      }

      try {
        const q = query(collection(db, "registrations"), where("registrationNumber", "==", regNumber));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          let foundValid = false;

          querySnapshot.forEach(docSnap => {
            let data = docSnap.data();

            if (data.dateOfRegistration) {
              const regDate = new Date(data.dateOfRegistration);
              regDate.setHours(0, 0, 0, 0);
              const today = new Date();
              today.setHours(0, 0, 0, 0); // normalize time to midnight for fair comparison

              // 7-day expiry
              const expiryDate = new Date(regDate);
              expiryDate.setDate(expiryDate.getDate() + 7);

              // Future date check
              if (regDate > today) {
                document.getElementById("error").textContent =
                  "This registration is not yet valid. The registration date is in the future.";
                document.getElementById("touristDetails").style.display = "none";
                foundValid = false;
                return;
              }

              // Expired check
              if (today > expiryDate) {
                document.getElementById("error").textContent =
                  "This registration has expired (valid for 7 days only).";
                document.getElementById("touristDetails").style.display = "none";
                foundValid = false;
                return;
              }
            } else {
              document.getElementById("error").textContent = "Invalid registration date.";
              document.getElementById("touristDetails").style.display = "none";
              foundValid = false;
              return;
            }


            let tourists = [];
            if (data.fullName) {
              tourists.push({
                name: data.fullName,
                age: calculateAge(data.dateOfBirth),
                sex: data.sex,
                nationality: getNationality(data.country),
                region: data.region || "Region not applicable"
              });
            } else if (data.groupMembers && Array.isArray(data.groupMembers)) {
              tourists = data.groupMembers.map(member => ({
                name: member.memberName,
                age: calculateAge(member.memberDOB),
                sex: member.memberSex,
                nationality: getNationality(data.groupCountry),
                region: data.groupRegion || "Region not applicable"
              }));
            }

            allTourists.push(...tourists);
            foundValid = true;
          });

          // ✅ Only render if a valid (non-expired) registration was found
          if (foundValid && allTourists.length > 0) {
            renderTablePage(1);
            document.getElementById("touristDetails").style.display = "block";
          } else {
            document.getElementById("touristDetails").style.display = "none";
          }

        } else {
          document.getElementById("error").textContent = "Registration number not found.";
          document.getElementById("touristDetails").style.display = "none";
        }
      } catch (error) {
        document.getElementById("error").textContent = "Error fetching data: " + error.message;
        document.getElementById("touristDetails").style.display = "none";
      }
    }


    let isSubmittingAttendance = false;
    // --- Firestore Save ---
    async function submitAttendance() {

      if (isSubmittingAttendance) return;

      isSubmittingAttendance = true;

      const submitBtn = document.getElementById("submitAttendanceBtn");
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Recording...";
      }
      try {
        let selectedSite = document.getElementById("siteSelect").value;
        let registrationNumber = document.getElementById("registrationNumber").value.trim();

        if (selectedTourists.size === 0) {
          alert("Please select at least one tourist.");
          return;
        }

        // ✅ Get selected tourists from the allTourists array
        let tourists = allTourists.filter(t => selectedTourists.has(t.name));

        // ✅ Save one attendance record per tourist
        for (const t of tourists) {
          await addDoc(collection(db, "attendance"), {
            registrationNumber: registrationNumber,
            name: t.name,
            age: t.age,
            sex: t.sex,
            nationality: t.nationality,
            region: t.region || "Region not applicable", // ✅ always available
            site: selectedSite,
            timestamp: new Date()
          });
        }

        alert("Attendance recorded successfully!");
        document.getElementById("touristDetails").style.display = "none";
        document.getElementById("registrationNumber").value = "REG-";
        document.getElementById("touristList").innerHTML = "";
        selectedTourists.clear(); // ✅ Clear after submission

      } catch (error) {
        console.error("Error submitting attendance: ", error);
        alert("Error saving attendance. Please try again.");
      } finally {
        isSubmittingAttendance = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Attendance";
        }
      }
    }


    // --- Event Listeners ---
    document.addEventListener("DOMContentLoaded", () => {
      const authLink = document.getElementById("authLink");
      const userValidated = localStorage.getItem("userValidated") === "true";

      if (userValidated) {
        authLink.textContent = "Profile";
        authLink.href = "/SagadaRegistrationSystem/user/profile/index.html";
        document.getElementById("body").style.visibility = "visible";
      } else {
        authLink.textContent = "Login";
        authLink.href = "/SagadaRegistrationSystem/user/user-auth.html";
        registerLink.style.display = "none";
        window.location.href = "/SagadaRegistrationSystem/user/user-auth.html";
        /* touristCheckInLink.style.display = "none";
        logoutLink.style.display = "none"; */
      }

      /* logoutLink.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.setItem("userValidated", "false");
          localStorage.removeItem("userId");
          localStorage.removeItem("userEmail");
          window.location.href = "/index.html";
      }); */
      const hamburger = document.getElementById("hamburger");
      const navLinks = document.getElementById("nav-links");

      // Toggle menu on hamburger click
      hamburger.addEventListener("click", (e) => {
        e.stopPropagation(); // prevent click bubbling
        navLinks.classList.toggle("show");
      });

      // Close menu if clicking outside
      document.addEventListener("click", (e) => {
        if (navLinks.classList.contains("show") && !navLinks.contains(e.target) && e.target !== hamburger) {
          navLinks.classList.remove("show");
        }
      });

      document.getElementById("registrationNumber").addEventListener("input", (e) => enforcePrefix(e.target));
      document.getElementById("fetchDetailsBtn").addEventListener("click", fetchDetails);
      document.getElementById("submitAttendanceBtn").addEventListener("click", submitAttendance);
      document.getElementById("selectAll").addEventListener("change", handleSelectAll);
    });
  </script>
</body>

</html>